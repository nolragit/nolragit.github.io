<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì½”ì¸ ê¸‰ë“± ì•Œë¦¼ (15ë¶„/5%)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .dot-red { background-color: #f85149; }
        .dot-green { background-color: #3fb950; }
        .dot-yellow { background-color: #ffd666; }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        #alertLog::-webkit-scrollbar,
        #monitorList::-webkit-scrollbar {
            width: 8px;
        }
        #alertLog::-webkit-scrollbar-thumb,
        #monitorList::-webkit-scrollbar-thumb {
            background-color: #484f58;
            border-radius: 4px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-white text-center">ğŸ“ˆ ì‹¤ì‹œê°„ ê¸‰ë“± ê°ì§€ ì‹œìŠ¤í…œ (15ë¶„ / 5%)</h1>

        <!-- ì„¤ì • ë° ìƒíƒœ ì˜ì—­ -->
        <div class="card p-4 rounded-xl shadow-lg mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div id="connectionStatus" class="flex items-center text-sm font-medium">
                    <span class="status-dot dot-yellow" id="statusDot"></span>
                    <span id="statusText">ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-semibold">ê¸°ì¤€: 15ë¶„ ë´‰ / +5%</div>
                    <button id="startButton" onclick="toggleMonitor()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸ : ëª¨ë‹ˆí„°ë§ ë¦¬ìŠ¤íŠ¸ì™€ ì•Œë¦¼ ë¡œê·¸ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- ëª¨ë‹ˆí„°ë§ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨ í‘œì‹œ) -->
            <div class="lg:col-span-1 card p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-3 text-white">ğŸ‘€ ëª¨ë‹ˆí„°ë§ ì¢…ëª© (<span id="symbolCount">0</span>ê°œ)</h2>
                <div id="monitorList" class="h-64 overflow-y-auto text-xs space-y-1">
                    <!-- ì¢…ëª© ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤. -->
                    <div class="text-center text-gray-500 py-4">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ ë¡œê·¸ -->
            <div class="lg:col-span-2 card p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-3 text-white">ğŸš¨ ê¸‰ë“± ì•Œë¦¼ ë¡œê·¸</h2>
                <div id="alertLog" class="h-64 overflow-y-auto space-y-2">
                    <!-- ì•Œë¦¼ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    <div class="text-center text-gray-500 py-4">ì•Œë¦¼ì´ ë°œìƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>

        </div>

    </div>

<script>
    // =================================================================
    // 1. ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
    // =================================================================

    // Binance API ì—”ë“œí¬ì¸íŠ¸
    const BINANCE_REST_BASE = 'https://fapi.binance.com'; // ì„ ë¬¼ REST API
    const BINANCE_WS_BASE = 'wss://fstream.binance.com/stream?streams='; // ì„ ë¬¼ WebSocket API
    
    // ë¶„ì„ ê¸°ì¤€ ì„¤ì •
    const INTERVAL = '1m'; // WS ë° REST API ì¡°íšŒ ê°„ê²©
    const CANDLE_COUNT = 15; // 15ë¶„ë´‰ ê¸°ì¤€ (1m ìº”ë“¤ 15ê°œ)
    const SURGE_THRESHOLD = 0.05; // 5% (5/100)
    const MAX_RETRIES = 5; // REST API ì¬ì‹œë„ íšŸìˆ˜
    
    // ëª¨ë‹ˆí„°ë§í•  ëŒ€í‘œì ì¸ ì„ ë¬¼ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (Binance USDT-M Futures)
    const BASE_SYMBOLS = [
        "BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT", 
        "ADAUSDT", "DOGEUSDT", "AVAXUSDT", "DOTUSDT", "LINKUSDT", 
        "TRXUSDT", "MATICUSDT", "LTCUSDT", "BCHUSDT", "UNIUSDT",
        "NEARUSDT", "APTUSDT", "ATOMUSDT", "ETCUSDT", "AXSUSDT",
        "FILUSDT", "SANDUSDT", "FTMUSDT", "AAVEUSDT", "THETAUSDT"
    ];

    let ws = null;
    let isMonitoring = false;
    // { 'BTCUSDT': { history: [kline], alertTime: null, lastPrice: 0, openPrice: 0, isLoading: true }, ... }
    let symbolData = {}; 

    // DOM ìš”ì†Œ ìºì‹œ
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const startButton = document.getElementById('startButton');
    const alertLog = document.getElementById('alertLog');
    const monitorListDiv = document.getElementById('monitorList');
    const symbolCountSpan = document.getElementById('symbolCount');


    // =================================================================
    // 2. ì´ˆê¸°í™” ë° UI í•¨ìˆ˜
    // =================================================================

    function updateStatus(text, type = 'yellow') {
        statusText.textContent = text;
        statusDot.className = `status-dot ${type === 'green' ? 'dot-green' : type === 'red' ? 'dot-red' : 'dot-yellow'}`;
    }

    function logAlert(symbol, change, price) {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ko-KR');

        const newLog = document.createElement('div');
        newLog.className = 'p-3 rounded-lg bg-red-800/30 border border-red-700/50 flex flex-col transition duration-300 transform hover:scale-[1.01]';
        newLog.innerHTML = `
            <div class="font-bold text-lg text-red-400">${symbol} ğŸš€ ê¸‰ë“± ê°ì§€!</div>
            <div class="text-sm text-gray-300">
                [${timeString}] ë³€ë™ë¥ : <span class="text-xl font-extrabold text-red-300">${(change * 100).toFixed(2)}%</span>
                / í˜„ì¬ê°€: $${price.toFixed(4)}
            </div>
        `;
        alertLog.prepend(newLog); // ìµœì‹  ì•Œë¦¼ì„ ìœ„ë¡œ ì¶”ê°€
        
        // ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°©ì§€
        if (alertLog.children.length > 50) {
            alertLog.removeChild(alertLog.lastChild);
        }
    }
    
    function updateMonitorListUI() {
        monitorListDiv.innerHTML = ''; // ì´ˆê¸°í™”
        const symbols = Object.keys(symbolData).sort();
        symbolCountSpan.textContent = symbols.length;

        symbols.forEach(symbol => {
            const data = symbolData[symbol];
            const div = document.createElement('div');
            
            let changeText = '';
            let isLoaded = data.history.length >= CANDLE_COUNT;

            if (data.isLoading) {
                // ë°ì´í„° ë¡œë”© ì¤‘
                changeText = `<div class="loading-spinner ml-2"></div>`;
            } else if (!isLoaded) {
                 // ë¡œë”©ì´ ëë‚¬ì§€ë§Œ ìº”ë“¤ ìˆ˜ê°€ ë¶€ì¡±í•œ ê²½ìš° (ì´ëŸ´ ì¼ì€ REST APIë¡œ ì¸í•´ ì—†ì–´ì•¼ í•¨)
                 changeText = 'ë°ì´í„° ìˆ˜ì§‘ ì¤‘...'; 
            } else {
                 // ë°ì´í„° ë¡œë“œ ì™„ë£Œ ë° ê³„ì‚° ê°€ëŠ¥
                 const currentPrice = data.history[data.history.length - 1].close;
                 const openPrice = data.history[0].open;
                 const change = (currentPrice - openPrice) / openPrice;
                 const color = change >= SURGE_THRESHOLD ? 'text-red-500 font-extrabold' : change > 0 ? 'text-green-500' : 'text-gray-500';
                 changeText = `<span class="${color}">${(change * 100).toFixed(2)}%</span>`;
            }
            
            // í˜„ì¬ ê°€ê²© ê¸°ë°˜ ìƒ‰ìƒ (Last Close Price)
            const priceColor = data.lastPrice > 0 ? (data.lastPrice >= data.openPrice ? 'text-green-400' : 'text-red-400') : 'text-gray-400';

            div.className = 'flex justify-between p-1.5 border-b border-gray-700/50 last:border-b-0 items-center';
            div.innerHTML = `
                <span class="font-medium">${symbol}</span>
                <span class="text-right text-xs flex items-center">
                    15m ë³€ë™ë¥ : ${changeText}
                </span>
            `;
            monitorListDiv.appendChild(div);
        });
    }

    // =================================================================
    // 3. REST APIë¥¼ ì´ìš©í•œ ì´ˆê¸° ë°ì´í„° ë¡œë”© (ì•ˆì •ì„± ê°œì„ )
    // =================================================================

    // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì´ìš©í•œ REST API í˜¸ì¶œ
    async function fetchKlineData(symbol, retryCount = 0) {
        // limit: ìš”ì²­í•  ìº”ë“¤ ìˆ˜. CANDLE_COUNT(15) + 1 (ìµœì‹  ìº”ë“¤ì˜ Close priceë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
        const url = `${BINANCE_REST_BASE}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=${CANDLE_COUNT + 1}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // Binance klines í˜•ì‹: [ timestamp, open, high, low, close, volume, ... ]
            // ìº”ë“¤ ë§ˆê° ì‹œê°„(0), open(1), high(2), low(3), close(4), volume(5)
            
            // ë§ˆì§€ë§‰ ë¯¸ì™„ì„± ìº”ë“¤(0)ê³¼ ì´ì „ 15ê°œ ìº”ë“¤(1~15)ì„ ê°€ì ¸ì™€ì•¼ í•¨.
            if (data.length < CANDLE_COUNT) {
                 console.warn(`${symbol}: Not enough historical data (${data.length} found). Skipping initial calculation.`);
                 return []; // ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
            }
            
            // ìº”ë“¤ ë°ì´í„° íŒŒì‹±
            // 15ë¶„ ê¸‰ë“± ê³„ì‚°ì„ ìœ„í•´ (CANDLE_COUNT)ê°œì˜ ìº”ë“¤ì„ í•„ìš”ë¡œ í•¨.
            // data[0]ì€ ê°€ì¥ ì˜¤ë˜ëœ ìº”ë“¤, data[14]ëŠ” ê°€ì¥ ìµœê·¼ì— ë§ˆê°ëœ ìº”ë“¤.
            // data[15]ëŠ” í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìº”ë“¤ (ë¯¸ì™„ì„±)ì´ë¯€ë¡œ, historyì— í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

            const parsedHistory = data.slice(0, CANDLE_COUNT).map(k => ({
                open: parseFloat(k[1]),
                close: parseFloat(k[4]),
                high: parseFloat(k[2]),
                low: parseFloat(k[3]),
                volume: parseFloat(k[5]),
                timestamp: k[0]
            }));

            // ë§ˆì§€ë§‰ ë§ˆê°ëœ ìº”ë“¤ì˜ ê°€ê²©ì„ WebSocket ì—°ê²° ì „ LastPriceë¡œ ì„¤ì •
            if(parsedHistory.length > 0) {
                 symbolData[symbol].lastPrice = parsedHistory[parsedHistory.length - 1].close;
                 symbolData[symbol].openPrice = parsedHistory[parsedHistory.length - 1].open;
            }

            return parsedHistory;

        } catch (error) {
            if (retryCount < MAX_RETRIES) {
                const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000; // ì§€ìˆ˜ ë°±ì˜¤í”„ + ëœë¤ ì§€ì—°
                console.warn(`[${symbol}] REST API í˜¸ì¶œ ì˜¤ë¥˜: ${error.message}. ${delay / 1000}ì´ˆ í›„ ì¬ì‹œë„... (${retryCount + 1}/${MAX_RETRIES})`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchKlineData(symbol, retryCount + 1); // ì¬ê·€ í˜¸ì¶œ
            } else {
                console.error(`[${symbol}] REST API í˜¸ì¶œ ìµœì¢… ì‹¤íŒ¨: ${error.message}. ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨.`);
                return [];
            }
        }
    }

    async function loadInitialData() {
        startButton.disabled = true;
        startButton.innerHTML = `<span class="loading-spinner mr-2"></span> ë°ì´í„° ë¡œë”© ì¤‘...`;
        updateStatus('ì´ˆê¸° ë°ì´í„° ë¡œë”© ì¤‘...', 'yellow');
        
        // 1. symbolData êµ¬ì¡° ì´ˆê¸°í™” ë° ë¡œë”© í”Œë˜ê·¸ ì„¤ì •
        symbolData = {};
        BASE_SYMBOLS.forEach(s => {
            symbolData[s] = { history: [], alertTime: null, lastPrice: 0, openPrice: 0, isLoading: true };
        });
        updateMonitorListUI();

        // 2. ëª¨ë“  ì¢…ëª©ì˜ ì´ˆê¸° ë°ì´í„° ë³‘ë ¬ ë¡œë”©
        const loadPromises = BASE_SYMBOLS.map(async (symbol) => {
            const history = await fetchKlineData(symbol);
            if (history.length === CANDLE_COUNT) {
                symbolData[symbol].history = history;
            }
            symbolData[symbol].isLoading = false;
        });

        // 3. ëª¨ë“  ë¡œë”©ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        await Promise.all(loadPromises);
        
        startButton.disabled = false;
        startButton.textContent = 'ëª¨ë‹ˆí„°ë§ ì‹œì‘';
        updateStatus('ì—°ê²° ëŒ€ê¸° ì¤‘...', 'yellow');
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë”© í›„ UI ì—…ë°ì´íŠ¸ (ê¸‰ë“± ì—¬ë¶€ ë°”ë¡œ ê³„ì‚° ê°€ëŠ¥)
        updateMonitorListUI();
        
        // ë¡œë”© ì™„ë£Œ í›„ (ì„ íƒ ì‚¬í•­): ê¸‰ë“± ê°ì§€ ë¡œì§ì„ í•œ ë²ˆ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ ìƒíƒœ í™•ì¸
        BASE_SYMBOLS.forEach(symbol => {
             if (symbolData[symbol].history.length === CANDLE_COUNT) {
                 calculateSurge(symbol);
             }
        });
    }

    // =================================================================
    // 4. WebSocket ë° í•µì‹¬ ë¡œì§
    // =================================================================

    function calculateSurge(symbol) {
        const data = symbolData[symbol];
        
        // 15ë¶„ ë°ì´í„°ë¥¼ ëª¨ë‘ ëª¨ì•˜ëŠ”ì§€ í™•ì¸ (ì´ˆê¸° ë¡œë”© ì„±ê³µ ì‹œ true)
        if (data.history.length < CANDLE_COUNT) {
            return;
        }

        // 15ë¶„ ì „ (15ë²ˆì§¸) ìº”ë“¤ì˜ Open Price (15ë¶„ êµ¬ê°„ì˜ ì‹œì‘ ê°€ê²©)
        const openPrice15m = data.history[0].open;
        
        // í˜„ì¬ (ë§ˆì§€ë§‰) ìº”ë“¤ì˜ Close Price
        const currentPrice = data.history[data.history.length - 1].close;

        const change = (currentPrice - openPrice15m) / openPrice15m;
        
        // 5% ì´ìƒ ê¸‰ë“± ê°ì§€
        if (change >= SURGE_THRESHOLD) {
            
            // ì•Œë¦¼ ì¤‘ë³µ ë°©ì§€ ë¡œì§: ì´ë¯¸ ì•Œë¦¼ì´ ë°œìƒí•œ í›„ 15ë¶„ ë™ì•ˆì€ ë‹¤ì‹œ ì•Œë¦¼ì„ ë°œìƒì‹œí‚¤ì§€ ì•ŠìŒ
            const now = Date.now();
            const lastAlert = data.alertTime || 0;
            const cooldownPeriod = 15 * 60 * 1000; // 15ë¶„ ì¿¨ë‹¤ìš´

            if (now - lastAlert > cooldownPeriod) {
                logAlert(symbol, change, currentPrice);
                symbolData[symbol].alertTime = now; // ì•Œë¦¼ ë°œìƒ ì‹œê°„ ê¸°ë¡
            }
        }
    }

    function handleMessage(event) {
        const message = JSON.parse(event.data);

        // Binance Combined Stream í˜•ì‹ í™•ì¸
        if (message.stream && message.data && message.data.k) {
            const kline = message.data.k;
            const symbol = kline.s;
            const isFinal = kline.x; // ìº”ë“¤ ë§ˆê° ì—¬ë¶€ (true = ë§ˆê°)

            if (!symbolData[symbol]) return;

            // ìº”ë“¤ ë°ì´í„° ì¶”ì¶œ: [Open, Close, High, Low, Volume]
            const candle = {
                open: parseFloat(kline.o),
                close: parseFloat(kline.c),
                high: parseFloat(kline.h),
                low: parseFloat(kline.l),
                volume: parseFloat(kline.v),
                timestamp: kline.T // ìº”ë“¤ ë§ˆê° ì‹œê°„
            };
            
            // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ (UI ëª©ë¡ ì—…ë°ì´íŠ¸ìš©)
            symbolData[symbol].lastPrice = candle.close;
            symbolData[symbol].openPrice = candle.open;


            // ìº”ë“¤ì´ ë§ˆê°ë˜ì—ˆì„ ë•Œë§Œ (ì•ˆì •ì ì¸ ë°ì´í„°)
            if (isFinal) {
                let history = symbolData[symbol].history;
                
                // ìƒˆë¡œìš´ ìº”ë“¤ì„ ì¶”ê°€
                // **ì¤‘ìš”**: ì´ˆê¸° ë°ì´í„° ë¡œë”© í›„, WebSocketì€ REST APIê°€ ë¶ˆëŸ¬ì˜¨ ë§ˆì§€ë§‰ ìº”ë“¤ê³¼ 
                // ë™ì¼í•œ ìº”ë“¤ì„ ë§ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ë³µ ë°©ì§€ ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
                
                // í˜„ì¬ historyì— ë§ˆì§€ë§‰ ìº”ë“¤ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ë¹„êµí•˜ì—¬ ì¤‘ë³µì´ ì•„ë‹ˆë©´ ì¶”ê°€
                const lastTimestamp = history.length > 0 ? history[history.length - 1].timestamp : 0;
                
                if (candle.timestamp > lastTimestamp) {
                     // 1ë¶„ë´‰ ë§ˆê° ì‹œê°„ì´ í˜„ì¬ ì €ì¥ëœ ë§ˆì§€ë§‰ ì‹œê°„ë³´ë‹¤ ë’¤ì¼ ê²½ìš°ì—ë§Œ ì¶”ê°€
                     history.push(candle);
                } else if (candle.timestamp === lastTimestamp) {
                     // ë§Œì•½ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ê°™ë‹¤ë©´, ì´ëŠ” REST APIì˜ ë§ˆì§€ë§‰ ìº”ë“¤ì„ WSê°€ ë‹¤ì‹œ ë§ˆê°í•œ ê²½ìš°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                     // ì´ ê²½ìš° ë°ì´í„°ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤. (ì•ˆì •ì„± í™•ë³´)
                     history[history.length - 1] = candle;
                }
                
                // 15ê°œ ìº”ë“¤ë§Œ ìœ ì§€ (FIFO: First-In, First-Out)
                if (history.length > CANDLE_COUNT) {
                    history.shift(); // ê°€ì¥ ì˜¤ë˜ëœ ìº”ë“¤ ì œê±°
                }
                
                // 15ê°œ ìº”ë“¤ì´ ëª¨ì˜€ì„ ë•Œë§Œ ë¶„ì„ ì‹¤í–‰ (ì´ˆê¸° ë¡œë”©ìœ¼ë¡œ ì´ë¯¸ ì¶©ì¡±ë  ê°€ëŠ¥ì„±ì´ ë†’ìŒ)
                if (history.length === CANDLE_COUNT) {
                    calculateSurge(symbol);
                }
                
                // ë§¤ ìº”ë“¤ ë§ˆê° ì‹œ UI ì—…ë°ì´íŠ¸
                updateMonitorListUI();
            }
        }
    }

    function connectWebSocket() {
        if (ws) {
            ws.close();
        }
        
        updateStatus('WebSocket ì—°ê²° ì¤‘...', 'yellow');

        // ëª¨ë‹ˆí„°ë§í•  ìŠ¤íŠ¸ë¦¼ ëª©ë¡ ìƒì„± (ì˜ˆ: btcusdt@kline_1m/ethusdt@kline_1m/...)
        const streams = BASE_SYMBOLS.map(s => `${s.toLowerCase()}@kline_${INTERVAL}`);
        const wsUrl = BINANCE_WS_BASE + streams.join('/');
        
        // REST API ë¡œë”©ì´ ì™„ë£Œëœ symbolData êµ¬ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            updateStatus('ğŸŸ¢ ëª¨ë‹ˆí„°ë§ í™œì„±í™”ë¨', 'green');
            startButton.textContent = 'ëª¨ë‹ˆí„°ë§ ì¤‘ì§€';
            startButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            startButton.classList.add('bg-red-600', 'hover:bg-red-700');
            isMonitoring = true;
        };

        ws.onmessage = handleMessage;

        ws.onclose = () => {
            if (isMonitoring) {
                updateStatus('âŒ ì—°ê²° ëŠê¹€. ì¬ì—°ê²° ì‹œë„ ì¤‘...', 'red');
                // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
                setTimeout(connectWebSocket, 5000); 
            } else {
                 updateStatus('ì—°ê²° ì¤‘ì§€ë¨', 'yellow');
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket ì˜¤ë¥˜ ë°œìƒ:', error);
            updateStatus('âŒ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ', 'red');
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì¬ì—°ê²° ë¡œì§ì„ íƒ€ë„ë¡ closeë¥¼ í˜¸ì¶œ
            ws.close(); 
        };
    }

    function disconnectWebSocket() {
        if (ws) {
            isMonitoring = false;
            ws.close();
            ws = null;
            updateStatus('ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨', 'yellow');
            startButton.textContent = 'ëª¨ë‹ˆí„°ë§ ì‹œì‘';
            startButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            startButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }
    }
    
    // =================================================================
    // 5. ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ ë° ì´ˆê¸° ì‹¤í–‰
    // =================================================================

    function toggleMonitor() {
        if (isMonitoring) {
            disconnectWebSocket();
        } else {
            // WS ì—°ê²° ì „, ì´ˆê¸° ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            const allLoaded = Object.values(symbolData).every(data => !data.isLoading);
            if (Object.keys(symbolData).length === 0 || !allLoaded) {
                 // ë°ì´í„° ë¡œë“œê°€ ì•„ì§ ì•ˆë˜ì—ˆê±°ë‚˜ ë¡œë“œì— ì‹¤íŒ¨í•œ ê²½ìš°
                 alert("ì´ˆê¸° ë°ì´í„° ë¡œë”©ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                 return;
            }
            connectWebSocket();
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹œì‘
    document.addEventListener('DOMContentLoaded', loadInitialData);
    
</script>

</body>
</html>
